# h4 Totally Legit Sertificate
## x) Lue/katso ja tiivistä
- OWASP Top 10:2021, A01: Broken Access Control

Syitä:
Vähimmäisoikeusperiaatteen tai oletuskiellon puuttuminen.
Pääsynhallinnan tarkistusten ohittaminen muuttamalla URLia, sisäisen sovelluksen tilaa tai HTML-sivua tai hyödyntämällä. Hyökkäystyökalua API-pyyntöjen muokkaamiseen.
Salliminen toisen henkilön tilin katseluun tai muokkaamiseen toimittamalla sen yksilöllinen tunniste.
API:n käyttö ilman tarvittavia pääsynhallintatarkistuksia POST-, PUT- ja DELETE-toiminnoille.
Käyttöoikeuksien korottaminen.
Metadatan manipulointi.
CORS-määritysvirheet.
Pakotettu selaus.

Keinot välttää:
Vähimmäisoikeusperiaate, oletuskielto, pääsynhallintamekanismien toteuttaminen vain kerran ja niiden uudelleenkäyttö koko sovelluksessa, sekä muita käytäntöjä kuten istunnon tunnisteiden oikea käsittely ja API-pyynnöille asetettavat rajoitukset.

- A10: SSRF Server-Side Request Forgery (SSRF)

Syitä:
SSRF-virheet tapahtuvat, kun verkkosovellus hakee etäresurssia ilman käyttäjän toimittaman URLin asianmukaista validointia. Palomuuri, VPN tai ACL eivät auta. Koska nykyaikaiset verkkosovellukset tarjoavat käyttäjille käteviä ominaisuuksia, URLin hakeminen on yleinen tilanne.

Keinot välttää:
Verkkokerroksessa:
Etäresurssien segmentointi eri verkoissa.
Oletuskielto.
Sovelluskerroksessa:
Puhdista ja validoi kaikki käyttäjän toimittamat syötteet.
Toteuta URL-skeema, portti ja kohde positiivisella sallittujen kohteiden listalla.
Älä lähetä raakoja vastauksia asiakkaille.
Poista HTTP-uudelleenohjaukset.

- Access control vulnerabilities and privilege escalation

Vertical access controls, Horizontal access controls, Context-dependent access controls. Vertical privilege escalation, Horizontal privilege escalation. IDORs. Referer-based access control, Location-based access control. 

- Server-side template injection

Voi mahdollistaa hyökkääjän syöttää ja suorittaa omaa koodia palvelinpuolella.


- Server-side request forgery (SSRF)

Voi mahdollistaa hyökkääjän suorittaa pyytöjä palvelimille, jotka vaarantavat turvallisuuden.

- Cross-site scripting

Cross-site scripting toimii manipuloimalla haavoittuvaa verkkosivustoa niin, että se palauttaa käyttäjille haitallista JavaScript-koodia. Kun haitallinen koodi suoritetaan kohteen selaimessa, hyökkääjä voi vaarantaa kohteen vuorovaikutuksen sovelluksen kanssa.

- Karvinen 2020: Using New Webgoat 2023.4 to Try Web Hacking

New webgoat asennus.

## a) Totally Legit Sertificate 
Ensiksi asensin javan kalille ja sen jälkeen latasin zapin "Cross Platform Package" https://www.zaproxy.org/download/ sivulta.

    $ sudo apt-get install default-jre

Siirryin downloads kansioon, jossa purin ja käynnistin zapin.

    $ cd Downloads
    $ unzip ZAP_2.14.0_Crossplatform.zip 
    $ cd ZAP_2.14.0 
    $ ./zap.sh
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a1.png)

Genereroin sertificaatin zapissa: Tools -> Options -> Dynamic SSL Certificates, ja muutin: Network -> Local Servers/Proxies portin 8081, koska kohtasin aluksi ongelmia. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a2.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a6.png)

Kävin lisäämässä sertifikaatin firefoxiin: Firefox -> Preferences -> Privacy & Security -> View Certificates -> Authorities -> Import.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a3.png)

Kävin muuttamassa fireroxin "network settings" asetuksia. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a5.png)

Nyt kun avasin kalin foorumin näkyi liikenne zapissa.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.a4.png)

## b) Kettumaista
Ensiksi suljin ZAPin ja muutin fireroxin "network settings" asetuksia valitsemalla "no proxy". 

Firefox burger-valikko -> more tool -> Extensions for developers -> hea: foxyproxy -> install FoxyProxy Standard.

Avasin FoxyProxy Standardin laajennuksista. Painoin add ja lisäsin nimen, ip:n ja portin.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.b1.png)

Avasin kali docs sivun ja nyt liikenne näkyy ZAPissa.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.b2.png)

## PortSwigger Labs. Ratkaise tehtävät. Selitä ratkaisusi: mitä palvelimella tapahtuu, mitä eri osat tekevät, miten hyökkäys löytyi, mistä vika johtuu.

## c) Insecure direct object references
Tehtävän annossa kerrottiin, että livechat tallentaa käyttäjien keskustelut suoraan palvelimen tiedostojärjestelmään ja hakee ne staattisten URL-osoitteiden avulla. Kun painoin "View transcript" latautui käyty keskustelu. Keskustelu latautui nimellä "2.txt". Keskeytin liikenteen zapissa ja yritin katsoa mitä tapahtuu. 

Kun liikennettä kelasi yksitelle eteenpäin oli ensimmäisessä response kohdassa sijainti mistä tiedosto ladataan. Normaalisti alussa luku oli "2" ja luku kasvoi aina, kun latasi keskustelun uudelleen "View transcript" kohdasta. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.c3.png)

Muutin sijainnin "1.txt" ja annoin pyynnön mennä läpi. Tällöin koneelle latautui tiedosto "1.txt"

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.c4.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.c1.png)

Tiedostosta nähdään ainakin, että puhe on jostain salasanasta. Oletan, että se on tehtävän annossa halutun carloksen salasana. Muuten jostain pitäisi varmaan saada selville vielä kuka tätä keskustelua olisi käyny, koska normaali tilanteessa käyttäjän nimi ei varmaan ole tiedossa muuten vaan aluksi.

Siirryin "My account" sivulle ja testasin Username: carlos, password: eqcs9eimb4rfmd8lk7r8.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.c5.png)

Carloksen käyttäjä on nyt vaarantunut.

## d) File path traversal, simple case
Tässä harjoituksessa haavoittuvuus on tuotteiden kuvien näyttämisessä. Joten menin katsomaan miltä liikenne näyttää, kun siirtyy yksittäisen tuotteen sivulle. 

Huomasin, että GET pyynnössä oli filename=3.jpg, joten muutin sen osoitteen ../../../etc/passwd.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.d3.png)

Sain vastaukseksi seuraavaa:

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.d2.png)

Vastaus näyttää /etc/passwd kansion sisällön.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.d4.png)

## e) File path traversal, traversal sequences blocked with absolute path bypass
Tehtävä on hyvin samanlainen kuin aikasempi. Valitsin zapissa history. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.e4.png)

Muutin jonkun filename=... perään /etc/passwd ja painoin "replay in console".

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.e3.png)

Vastauksena tuli /etc/passwd sisältö.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.e2.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.e5.png)

## f) File path traversal, traversal sequences stripped non-recursively
Avasin history ikkunan. Testasin aluksi muokata jonkin pyynnön parametria seuraavaksi filename=../../../etc/passwd.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.f1.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.f2.png)

Vastaukseksi tuli seuraavaa. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.f3.png)

Koska en ymmärtänyt miksi en saa vastausta katsoin [lähteen 8] videon. Selvisi, että yleisesti aina palvelin tarkistaa käyttäjän lähettämät syötteen traversaalisekvenssien varalta ja ne poistetaan. Palvelin tekee tätä niin kauan, kunnes haku ei sisällä enää "../" hakuja. Siksi sain vastaukseksi "504 Gateway Timeout". Kuitenkin tehtävän palvelin tarkastaa käyttäjän syötteen vain kerran jolloin tätä pystytään hyödyntämään lisäämällä "../" toinen samanlainen eli "....//". Tällöin palvelimen tarkistuksen jälkeen jäljelle jää "../" eli polun travertsointi onnistuu.

Muutin GET pyynnön filename=....//....//....//etc/passwd. Vastaukseksi sain jostain syystä saman viestin, vaikka portswiggerin mukaan harjoitus meni läpi. En selvittänyt syytä tälle, koska muutenkin zap käyttö on hankalaa.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.f5.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.f4.png)

## g) Server-side template injection with information disclosure via user-supplied objects
Kirjauduin harjoituksessa sisään tehtävänannossa annetuilla tunnuksilla. 

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g1.png)

Menin katsomaan jotain tuotetta ja sivun alalaidassa oli "Edit template". Painoin siitä.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g2.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g3.png)

Huomasin, että sivulla on palvelinpuolen template, joten kokeilin yhtien sulkujen sisään 1+1, joka tuotti seuraavaa:

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g4.png)

Poistin templatesta muun tekstin paitsi sen mitä halua kokeilla. Tulosteesta huomataan, että kyseessä on django template. Hain netistä miten django template injektioita tehdään. Koska tehtävän annossa luki, että pitää etsiä kehyksen salainen avain, testasin aluksi [lähteestä 9](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#django-templates) löytämääni kohtaa "Leaking app’s Secret Key" mutta tämä ei tuottanut mitään tulosta.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g5.png)

Testasin seuraavaksi lähteestä löytynyttä "Debug information leak" kohtaa, joka tulosti paljon kaikkea.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g6.png)

Koska en ymmärrä hirveesti tästä mitään, [lähteen 11](https://www.youtube.com/watch?v=8o5QPU-BvFQ&ab_channel=SevenSeasSecurity) avulla tiesin mitä hakea ja hain netistä "django settings". Valitsin [lähtee 10](https://docs.djangoproject.com/en/4.2/ref/settings/), joka on dokumentaatio djangon asetuksista. Koska tehtävässä etsitään salaista avainta hain sivulta "secret" ja lyösin "SECRET_KEY" kohdan.

Testasin hakea djangon tempaltelta settings.SECRET_KEY

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g8.png)

Tämä tulostin jonkun avaimen, joten kokeilin sitä tehtävän "Submit solution" kohtaan ja pääsin harjoituksen läpi.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g9.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.g10.png)

## h) Basic SSRF against the local server
Aloitin tehtävän. Valitsin jonkin tuotteen. Pysäytin ZAPilla liikenteen ja painoin sivun alalaidassa "Check stock". Muutin stockApi pyyntöä:

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.h1.png)

Nyt sivun alhaalle ilmestyi "Users" valikko. Testasin painaa carloksen käyttäjän kohdalta delete, mutta tuli seuraava vastaus.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.h2.png)

Joten menin takas tuotteen sivulle ja pysäytin liikenteen uudelleen ja painoin sivun alalaidassa "Check stock". Nyt muutin stockApi pyyntöä seuraavasti.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.h3.png)

Tämän jälkeen harjoitus ilmoitti, että pääsin sen läpi. Kävin vielä katsomassa miltä users valikko näyttää muuttamalla stockapi pyyntöä http://localhost/admin.

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.h4.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.h5.png)

## i) Reflected XSS into HTML context with nothing encoded
Kysyin chatGPT:ltä miten kokeilen "miten kokeilen  reflected cross-site scripting hakutoimintoon?".

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.i4.png)

Tämän jälkeen testasin hakukenttään <script>alert('test');</script>

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.i2.png)

Sain hälytyksen ja pääsin harjoitusksen läpi

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.i1.png)
![Alt text](/H4TotallyLegitSertificate/kuvat/h4.i3.png)

## j) Stored XSS into HTML context with nothing encoded
Avasin harjoituksen ja valitsin ensimmäisen postauksn kohdalta "view post".

Lisäsin kommentin seuraavasti:

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.j1.png)

Tämän jälkeen, kun painoin "Back to blog" tuli seuraava hälytys:

![Alt text](/H4TotallyLegitSertificate/kuvat/h4.j2.png)

Nytten, kun menin blogin kotisivulle ja painoin "view post" uudestaan tuli myös sama hälytys.

## k) Asenna Webgoat 2023.4
Asensin aluksi tulimuurin. (jos ei ole javaa se pitää asentaa myös)

    $ sudo apt-get install ufw
    $ sudo ufw enable
    ($ sudo apt-get install openjdk-17-jre)
Sitten asensin webgoatin version 2023.4:

    $ wget https://github.com/WebGoat/WebGoat/releases/download/v2023.4/webgoat-2023.4.jar --2023-11-17 18:10:37 https://github.com/WebGoat/WebGoat/releases/download/v2023.4/webgoat-2023.4.jar






## Lähteet
1 https://terokarvinen.com/2023/eettinen-hakkerointi-2023/

2 https://portswigger.net/web-security/cross-site-scripting

3 https://portswigger.net/web-security/ssrf

4 https://portswigger.net/web-security/server-side-template-injection

5 https://portswigger.net/web-security/access-control

6 https://terokarvinen.com/2023/webgoat-2023-4-ethical-web-hacking/

7 https://www.youtube.com/watch?v=JY1hsK-8gjI&t=12s&ab_channel=ArkenstoneLearning

8 https://www.youtube.com/watch?v=n0M-nOEB6a8&ab_channel=z3nsh3ll

9 https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#django-templates

10 https://docs.djangoproject.com/en/4.2/ref/settings/

11 https://www.youtube.com/watch?v=8o5QPU-BvFQ&ab_channel=SevenSeasSecurity




