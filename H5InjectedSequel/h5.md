# h5 Injected Sequel

## x) Lue/katso/kuuntele ja tiivistä.
Karvinen 2016: PostgreSQL Install and One Table Database – SQL CRUD tutorial for Ubuntu (Virtuaaliympäristöä ei tarvita, voit aloittaa kohdasta "Three line install"

- PostgreSQL asetaminen
- Taulun luominen
- Read, update, delete

OWASP 2017: A1:2017-Injection

Kuinka välttää:

- Datan erottamista komentoriveistä ja kyselyistä.
- Turvallista API:a tai ORM-työkalut.
- Positiivinen tai "whitelist" -pohjainen palvelinpohjainen syötteen tarkistus.
- Dynaamisille kyselyille käytä escape-syntaksia erikoismerkkien suojaamiseksi.
- Käytä SQL-ohjaimia, kuten LIMIT.

PortSwigger Academy: SQL injection

Paljon ja vähän lisää SQL injektioista.

SQL haavoittuvuus esiintyy yleensä WHERE-lausekkeen sisällä SELECT-kyselyssä.<br>UPDATE-lauseissa päivitettyjen arvojen tai WHERE-lausekkeen sisällä.<br>INSERT-lauseissa lisättyjen arvojen sisällä.<br>SELECT-lauseissa taulun tai sarakkeen nimen sisällä.<br>SELECT-lauseissa ORDER BY -lausekkeen sisällä.

SQL injektioiden estämisessä auttaa 'string concatenation' korvaaminen 'parameterized queries'.

## a) PostgreSQL CRUD
PostgreSQL tietokannan asentaminen. Kun yritin asentaa sitä huomasin, että minulla oli postgreSQL jo asennettuna.

    $ sudo apt-get -y install postgresql 
![Alt text](/H5InjectedSequel/kuvat/h5.a1.png)

Sitten yritin luodan tietokanna ja tietokannalle käyttäjän. Oli hieman hämmentynyt vastauksista.

    $ sudo -u postgres createdb $(whoami)
    $ sudo -u postgres createuser $(whoami)

![Alt text](/H5InjectedSequel/kuvat/h5.a2.png)
![Alt text](/H5InjectedSequel/kuvat/h5.a3.png)

Hieman ihmettelin välissä, jonka jälkeen kokeilin tietokannan luontia uudestaan ja vastaus oli erilainen. Kai noi aikasemmat komennot tekivät oikeita asioita vaikka tuloste on hieman erikoinen.

![Alt text](/H5InjectedSequel/kuvat/h5.a4.png)

Kuitenkin uusi tietokanta näkyi SQL:ssä. Asiaa hieman googletettua päätin muuttaa kansioini oikeuksia.

    $ chmod og+rX /home /home/user

![Alt text](/H5InjectedSequel/kuvat/h5.a5.png)

Tämän jälkeen siirryin sql tilaan ja loin uuden taulun

    $ sudo -u postgres psql
    \c jokke
    CREATE TABLE taskh5 (id SERIAL PRIMARY KEY, name VARCHAR(10));

![Alt text](/H5InjectedSequel/kuvat/h5.a7.png)

CRUD:

- Create
  
Loin 'Create' osan taskh5 tauluun.

      $ INSERT INTO taskh5(name) VALUES ('Create');
- Read
  
Luin 'Create' osan sisällön.

      $ SELECT * FROM taskh5;
![Alt text](/H5InjectedSequel/kuvat/h5.a8.png)
- Update
  
Päivitin tauluun luodun tietueen nimen 'Create' nimeksi 'Update'.

      $ UPDATE taskh5 SET name='Update' WHERE name='Create';
![Alt text](/H5InjectedSequel/kuvat/h5.a9.png)
  
- Delete
  
Lisäsin ensiksi uuden tietueen

      INSERT INTO taskh5(name) VALUES ('PoistaTama');
![Alt text](/H5InjectedSequel/kuvat/h5.a10.png)

Ja poistin sen seuraavasti:

      DELETE FROM taskh5 WHERE name='PoistaTama';
![Alt text](/H5InjectedSequel/kuvat/h5.a11.png)

## b) SQLi me. Kuvaile yksinkertainen SQL-injektio, ja demonstroi se omaan tietokantaasi psql-komennolla. 
Otetaan esimerkiksi mahdollinen käyttäjän antama syöte, joka voisi olla nimi, ja oletetaan, että se käytetään SQL-kyselyssä ilman asianmukaista suojausta. Esimerkiksi, jos sovelluksessa on seuraava koodi:

    kayttajan_syote = "käyttajan_syote'; DROP TABLE taskh5; --"
    sql_kysely = f"INSERT INTO taskh5(name) VALUES ('{kayttajan_syote}');"
Tässä käyttäjän syöte sisällytetään suoraan SQL-kyselyyn ilman asianmukaista suojelua. Käyttäjä voi yrittää syöttää manipuloivan syötteen, kuten:

    käyttajan_syote'; DROP TABLE taskh5; --
Tämä voi johtaa SQL-injektioon, ja kysely voi näyttää seuraavalta:

    INSERT INTO taskh5(name) VALUES ('käyttajan_syote'; DROP TABLE taskh5; --');
Tässä tapauksessa, jos sovellus ei ole asianmukaisesti suojattu SQL-injektioilta, se voisi tulkita tämän syötteen väärin ja suorittaa myös DROP TABLE -käskyn, mikä poistaisi "taskh5"-taulun.

## PortSwigger Labs
## c) (Alakohta c poistettu, tämänhän ratkoimme jo aiemmin: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data)

## d) SQL injection vulnerability allowing login bypass
Tehtävänä on suorittaa SQL injektio, joka kirjautuu sovellukseen administraattorina. Tehtävänanto kertoo, että haavoittuvuus löytyy sisäänkirjautumisessa. Liikenteen tarkasteluun käytin ZAP 2.14.0.

Avasin labran ja siirryin 'My account' sivulle. Pysäytin liikenteen ja lähtetin testi kirjautumisen.

![Alt text](/H5InjectedSequel/kuvat/h5.d1.png)

Kirjautumisen POST pyynnössä löytyi syöttämäni arvot. Tein uuden kirjautumispyynnön jossa arvauksella laitoin perus OR 1=1-- SQL injektion salasanaan 'username=administrator' ja "password=xx'OR 1=1--". Liikenne näytti seuraavalta.

![Alt text](/H5InjectedSequel/kuvat/h5.d2.png)
![Alt text](/H5InjectedSequel/kuvat/h5.d3.png)

Tällä pääsin kirjautumaan admin käyttäjälle ja nyt pääsisi halutessaan tekemään kaikkea ei toivottua saavutetuilla oikeuksilla. 

## e) SQL injection attack, querying the database type and version on Oracle
Tehtävänä on yrittää selvittää tietokannan tyyppi ja versio. Tehtävänanto kertoo, että SQL haavoittuvuus löytyy kategoria filtteristä ja että kyseessä on ORACLE tietokanta.

Harjoitussivulta valitsin jonkun kategorian ja testasin SQL injektioiden cheat sheetin komentoa.

![Alt text](/H5InjectedSequel/kuvat/h5.e1.png)

Tämä ei toiminut. Sitten tajusin lisätä sen kategorien perään ja testasin tehtävänannon esimerkkiä 

    '+UNION+SELECT+'abc'+FROM+dual--

![Alt text](/H5InjectedSequel/kuvat/h5.e2.png)
![Alt text](/H5InjectedSequel/kuvat/h5.e3.png)

Testasin lisätä toisen muuttujan lausekkeeseen. 

    '+UNION+SELECT+'abc','123'+FROM+dual--
Tämä toimi, koska sivun alalaitaan tuli osa:

![Alt text](/H5InjectedSequel/kuvat/h5.e4.png)

Nyt pitäisi vielä saada versio haettua tietokannasta. Muutin hakua siten, että korvasin toisen muuttujan 'banner' ja vaihdoin 'dual' tilalle 'v$version'.

![Alt text](/H5InjectedSequel/kuvat/h5.e6.png)
![Alt text](/H5InjectedSequel/kuvat/h5.e5.png)
![Alt text](/H5InjectedSequel/kuvat/h5.e7.png)


Nyt kaikki halutut tyyppi ja versio tiedot näkyvät sivulla sivun normaalien teksitien välissä. Ensimmäisellä rivillä on CORE.. ja alempana on lisää lisää tietokannan tietoja kunten NLSRTL..., Oracle Database 11g..., jne. 

## f) SQL injection attack, querying the database type and version on MySQL and Microsoft







## Lähteet
1  https://terokarvinen.com/2023/eettinen-hakkerointi-2023/<br>2  https://terokarvinen.com/2016/03/05/postgresql-install-and-one-table-database-sql-crud-tutorial-for-ubuntu/<br>3  https://portswigger.net/web-security/sql-injection<br>https://owasp.org/www-project-top-ten/2017/A1_2017-Injection<br>4  https://dba.stackexchange.com/questions/54242/cannot-start-psql-with-user-postgres-could-not-change-directory-to-home-user<br>5
